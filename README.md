# libgit2-d

`@safe` D bindings for libgit2.

## Maintainers' notes

### Generating Bindings

This shouldn't be required. When updating the bindings to new versions, consult
[Updating Bindings](#Updating-Bindings) section. If you really need to generate
the bindings, build the libgit2 subproject using CMake, install it to a local
directory, use `clang` (NOT `gcc`!) to preprocess the header file `git2.h` to
`git2.i`, and lastly run [`dstep`](https://github.com/jacob-carlborg/dstep) on
it.

```bash
cmake -DBUILD_TESTS=OFF -B build -S .
make -C build
DESTDIR="$PWD/install" make -C build install
clang -E -I$PWD/install/usr/local/include $PWD/install/usr/local/include/git2.h -o source/git2/git2.i
dstep source/git2/git2.i -o source/git2/bindings.d
```

### Updating Bindings

Thankfully the maintainers of [libgit2](https://github.com/libgit2/libgit2) have
been doing a tremendous job of keeping their changelog detailed. In addition,
libgit2 rarely makes huge changes in its public API. Therefore, once we have the
initial generated bindings, we can simply update the bindings by hand according
to either the changelog or the diffs between tags generated by GitHub.

When hand-authoring these new functions/structs, you may consult the existing
generated bindings as a reference.

If the new API is a completely new header file, you can use `dstep` to process
that single header file (without preprocessing) after performing the build and
install steps specified in the [Generating Bindings](#Generating-Bindings)
section.

### Making It Ergonomic

1. All pointers should be replaced with the `scope ref` attribute as much as
   possible.
2. If a parameter is passed to be assigned (e.g. `git_clone`,
   `git_XXX_option_init`), use the `scope out` attribute instead. You can
   usually infer this through the API documentation or the paramter name (i.e.
   `out_`).
3. Anything with `ref`/`out` disallows passing lvalues to it, therefore rule (1)
   will break any function that intends you to pass `null` to indicate an
   optional parameter. When this happens, copy the function into the `extra.d`
   file and only add a `scope` attribute to that particular parameter. Any other
   parameter can be annotated according to rule (1) and (2).
   (for reference, search for the definition of the two `git_clone`
   functions). 

On the ABI level, the signature of the functions are not changed. This is
only for the purpose of satisfying the compiler and adhereing to Safe-D.
(If you're wondering why we can't use the `in` attribute, this is because
with `--preview=in`, `in` is not allowed in `extern(C)` functions)

